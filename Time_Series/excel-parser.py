import pandas as pd
import sys

#this program parses the excel file generated by https://aps.dac.gov.in/APY/Public_Report1.aspx
#Each excel sheet containing information of a state

def isNaN(string):
     return string != string

input_file = sys.argv[1]
state = input_file.split(".")[0]
output_file = state+".csv"
book = pd.read_excel(input_file)

row_iter = 1
col_iter = 0

final_iter = -1
final = pd.DataFrame(columns=['State','District','Crop','Season','2010-11','2011-12','2012-13','2013-14','2014-15','2015-16','2016-17','2017-18','2018-19','2019-20','2020-21'])

Parse_Year = {'2010-11':4,'2011-12':5,'2012-13':6,'2013-14':7,'2014-15':8,'2015-16':9,'2016-17':10,'2017-18':11,'2018-19':12,'2019-20':13,'2020-21':14}

crop_name=""
district_name=""
year = ""
season = ""
while True :

    row_iter = row_iter + 1
    if row_iter == len(book) :
        break
    if book.iloc[row_iter][0] and book.iloc[row_iter][1:].isnull().all(): #crop name
       crop_name= book.iloc[row_iter][0].strip()
    elif (not isNaN(book.iloc[row_iter][0])) and book.iloc[row_iter][1:].notnull().all(): #row containing district name
        district_name=book.iloc[row_iter][0].split(".")[1].strip()
        year = book.iloc[row_iter][1].strip()
        season = book.iloc[row_iter][2].strip()
        final_iter=final_iter+1
        final.loc[final_iter]=""
        final.loc[final_iter][0] = state
        final.loc[final_iter][1] = district_name
        final.loc[final_iter][2] = crop_name
        final.loc[final_iter][3] = season
        final.loc[final_iter][Parse_Year[year]] = book.iloc[row_iter][5]
    elif isNaN(book.iloc[row_iter][0]) and book.iloc[row_iter][1:].notnull().all(): #normal row
        season = book.iloc[row_iter][2].strip()
        year = book.iloc[row_iter][1].strip()
        final.loc[final_iter][3] = season
        final.loc[final_iter][Parse_Year[year]] = book.iloc[row_iter][5]


print(final)
final.to_csv(output_file,index=False)
